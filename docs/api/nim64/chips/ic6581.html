<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!--  This file is generated by Nim. -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Favicon -->
<link rel="shortcut icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAUAAAAF////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAIAAABbAAAAlQAAAKIAAACbAAAAmwAAAKIAAACVAAAAWwAAAAL///8A////AP///wD///8A////AAAAABQAAADAAAAAYwAAAA3///8A////AP///wD///8AAAAADQAAAGMAAADAAAAAFP///wD///8A////AP///wAAAACdAAAAOv///wD///8A////AP///wD///8A////AP///wD///8AAAAAOgAAAJ3///8A////AP///wAAAAAnAAAAcP///wAAAAAoAAAASv///wD///8A////AP///wAAAABKAAAAKP///wAAAABwAAAAJ////wD///8AAAAAgQAAABwAAACIAAAAkAAAAJMAAACtAAAAFQAAABUAAACtAAAAkwAAAJAAAACIAAAAHAAAAIH///8A////AAAAAKQAAACrAAAAaP///wD///8AAAAARQAAANIAAADSAAAARf///wD///8AAAAAaAAAAKsAAACk////AAAAADMAAACcAAAAnQAAABj///8A////AP///wAAAAAYAAAAGP///wD///8A////AAAAABgAAACdAAAAnAAAADMAAAB1AAAAwwAAAP8AAADpAAAAsQAAAE4AAAAb////AP///wAAAAAbAAAATgAAALEAAADpAAAA/wAAAMMAAAB1AAAAtwAAAOkAAAD/AAAA/wAAAP8AAADvAAAA3gAAAN4AAADeAAAA3gAAAO8AAAD/AAAA/wAAAP8AAADpAAAAtwAAAGUAAAA/AAAA3wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAADfAAAAPwAAAGX///8A////AAAAAEgAAADtAAAAvwAAAL0AAADGAAAA7wAAAO8AAADGAAAAvQAAAL8AAADtAAAASP///wD///8A////AP///wD///8AAAAAO////wD///8A////AAAAAIcAAACH////AP///wD///8AAAAAO////wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A//8AAP//AAD4HwAA7/cAAN/7AAD//wAAoYUAAJ55AACf+QAAh+EAAAAAAADAAwAA4AcAAP5/AAD//wAA//8AAA=="/>
<link rel="icon" type="image/png" sizes="32x32" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAA3XAAAN1wFCKJt4AAAAB3RJTUUH4QQQEwksSS9ZWwAAAk1JREFUWMPtll2ITVEUx39nn/O7Y5qR8f05wtCUUr6ZIS++8pEnkZInPImneaCQ5METNdOkeFBKUhMPRIkHKfEuUZSUlGlKPN2TrgfncpvmnntnmlEyq1Z7t89/rf9a6+y99oZxGZf/XeIq61EdtgKXgdXA0xrYAvBjOIF1AI9zvjcC74BSpndrJPkBWDScTF8Aa4E3wDlgHbASaANmVqlcCnwHvgDvgVfAJ+AikAAvgfVZwLnSVZHZaOuKoQi3ZOMi4NkYkpe1p4J7A8BpYAD49hfIy/oqG0+hLomiKP2L5L+1ubn5115S+3OAn4EnwBlgMzCjyt6ZAnQCJ4A7wOs88iRJHvw50HoujuPBoCKwHWiosy8MdfZnAdcHk8dxXFJ3VQbQlCTJvRBCGdRbD4M6uc5glpY3eAihpN5S5w12diSEcCCEcKUO4ljdr15T76ur1FDDLIQQ3qv71EdDOe3Kxj3leRXyk+pxdWnFWod6Wt2bY3de3aSuUHcPBVimHs7mK9WrmeOF6lR1o9qnzskh2ar2qm1qizpfXaPeVGdlmGN5pb09qMxz1Xb1kLqgzn1RyH7JUXW52lr5e/Kqi9qpto7V1atuUzfnARrV7jEib1T76gG2qxdGmXyiekkt1GswPTtek0aBfJp6YySGBfWg2tPQ0FAYgf1stUfdmdcjarbYJEniKIq6gY/Aw+zWHAC+p2labGpqiorFYgGYCEzN7oQdQClN07O1/EfDyGgC0ALMBdYAi4FyK+4H3gLPsxfR1zRNi+NP7nH5J+QntnXe5B5mpfQAAAAASUVORK5CYII=">

<!-- Google fonts -->
<link href='https://fonts.googleapis.com/css?family=Lato:400,600,900' rel='stylesheet' type='text/css'/>
<link href='https://fonts.googleapis.com/css?family=Source+Code+Pro:400,500,600' rel='stylesheet' type='text/css'/>

<!-- CSS -->
<title>nim64/chips/ic6581</title>
<link rel="stylesheet" type="text/css" href="../../nimdoc.out.css">

<script type="text/javascript" src="../../dochack.js"></script>

<script type="text/javascript">
function main() {
  var pragmaDots = document.getElementsByClassName("pragmadots");
  for (var i = 0; i < pragmaDots.length; i++) {
    pragmaDots[i].onclick = function(event) {
      // Hide tease
      event.target.parentNode.style.display = "none";
      // Show actual
      event.target.parentNode.nextElementSibling.style.display = "inline";
    }
  }

  const toggleSwitch = document.querySelector('.theme-switch input[type="checkbox"]');
  function switchTheme(e) {
      if (e.target.checked) {
          document.documentElement.setAttribute('data-theme', 'dark');
          localStorage.setItem('theme', 'dark');
      } else {
          document.documentElement.setAttribute('data-theme', 'light');
          localStorage.setItem('theme', 'light');
      }
  }

  toggleSwitch.addEventListener('change', switchTheme, false);

  const currentTheme = localStorage.getItem('theme') ? localStorage.getItem('theme') : null;
  if (currentTheme) {
    document.documentElement.setAttribute('data-theme', currentTheme);

    if (currentTheme === 'dark') {
      toggleSwitch.checked = true;
    }
  }
}
</script>

</head>
<body onload="main()">
<div class="document" id="documentId">
  <div class="container">
    <h1 class="title">nim64/chips/ic6581</h1>
    <div class="row">
  <div class="three columns">
  <div class="theme-switch-wrapper">
    <label class="theme-switch" for="checkbox">
      <input type="checkbox" id="checkbox" />
      <div class="slider round"></div>
    </label>
    &nbsp;&nbsp;&nbsp; <em>Dark Mode</em>
  </div>
  <div id="global-links">
    <ul class="simple">
    <li>
      <a href="../../theindex.html">Index</a>
    </li>
    </ul>
  </div>
  <div id="searchInputDiv">
    Search: <input type="text" id="searchInput"
      onkeyup="search()" />
  </div>
  <div>
    Group by:
    <select onchange="groupBy(this.value)">
      <option value="section">Section</option>
      <option value="type">Type</option>
    </select>
  </div>
  <ul class="simple simple-toc" id="toc-list">
<ul class="simple"><li><a class="reference" id="voices_toc" href="#voices">Voices</a></li>
<ul class="simple"><li><a class="reference" id="voices-waveform-generators_toc" href="#voices-waveform-generators">Waveform Generators</a></li>
<li><a class="reference" id="voices-envelope-generator_toc" href="#voices-envelope-generator">Envelope Generator</a></li>
<li><a class="reference" id="voices-amplitude-modulator_toc" href="#voices-amplitude-modulator">Amplitude modulator</a></li>
</ul><li><a class="reference" id="filterslashmixer_toc" href="#filterslashmixer">Filter/mixer</a></li>
<li><a class="reference" id="external-filter_toc" href="#external-filter">External filter</a></li>
<li><a class="reference" id="potentiometers_toc" href="#potentiometers">Potentiometers</a></li>
<li><a class="reference" id="readminusonly-versus-writeminusonly-registers_toc" href="#readminusonly-versus-writeminusonly-registers">Read-only versus write-only registers</a></li>
<li><a class="reference" id="pin-interface_toc" href="#pin-interface">Pin interface</a></li>
</ul><li>
  <a class="reference reference-toplevel" href="#6" id="56">Imports</a>
  <ul class="simple simple-toc-section">
    
  </ul>
</li>
<li>
  <a class="reference reference-toplevel" href="#7" id="57">Types</a>
  <ul class="simple simple-toc-section">
      <li><a class="reference" href="#Ic6581"
    title="Ic6581 = ref object
  pins: Pins
  registers: Registers">Ic6581</a></li>

  </ul>
</li>
<li>
  <a class="reference reference-toplevel" href="#12" id="62">Procs</a>
  <ul class="simple simple-toc-section">
      <ul class="simple nested-toc-section">registers
      <li><a class="reference" href="#registers%2CIc6581"
    title="registers(chip`gensym1: Ic6581): seq[RegisterInfo]">registers,<wbr>Ic6581</a></li>

  </ul>
  <ul class="simple nested-toc-section">newIc6581
      <li><a class="reference" href="#newIc6581"
    title="newIc6581(): Ic6581">newIc6581</a></li>

  </ul>
  <ul class="simple nested-toc-section">pins
      <li><a class="reference" href="#pins%2CIc6581"
    title="pins(chip`gensym0: Ic6581): seq[PinInfo]">pins,<wbr>Ic6581</a></li>

  </ul>
  <ul class="simple nested-toc-section">[]
      <li><a class="reference" href="#%5B%5D%2CIc6581%2Cint"
    title="`[]`(chip`gensym0: Ic6581; index`gensym0: int): Pin">[],<wbr>Ic6581,<wbr>int</a></li>
  <li><a class="reference" href="#%5B%5D%2CIc6581%2Cstring"
    title="`[]`(chip`gensym0: Ic6581; index`gensym0: string): Pin">[],<wbr>Ic6581,<wbr>string</a></li>

  </ul>

  </ul>
</li>
<li>
  <a class="reference reference-toplevel" href="#15" id="65">Iterators</a>
  <ul class="simple simple-toc-section">
      <li><a class="reference" href="#items.i%2CIc6581"
    title="items(chip`gensym0: Ic6581): Pin">items</a></li>
  <li><a class="reference" href="#pairs.i%2CIc6581"
    title="pairs(chip`gensym0: Ic6581): (int, Pin)">pairs</a></li>

  </ul>
</li>
<li>
  <a class="reference reference-toplevel" href="#19" id="69">Exports</a>
  <ul class="simple simple-toc-section">
    
  </ul>
</li>

</ul>

  </div>
  <div class="nine columns" id="content">
  <div id="tocRoot"></div>
  
  <p class="module-desc"><p>An emulation of the 6581 Sound Interface Device.</p>
<p>The 6581 was designed as an advanced (for 1982) synthesizer, something that would set the new Commodore 64 apart from similar home computers. It has three individual oscillators that are each controlled with their own envelope generators and amplitude modulators. The outputs from these &quot;voices&quot; can optionally then be sent through a programmable audio filter (analog in the physical 6581, simulated digitally here), and then they are mixed for output. Tacked onto this is the capability to handle two game paddles (potentiometers).</p>
<p>These features are controlled with a collection of 29 registers (32 addresses are available with the 5 address inputs, but the last three addresses are unused). The first 25 are write-only; these are 7 for control of each of the three voices and 4 for control of the filter and mixer. The final 4 registers are read-only and provide information about the potentiometers and the internals of voice 3.</p>
<table border="1" class="docutils"><tr><th>Offset</th><th>Register</th><th>R/W</th><th>Description</th></tr>
<tr><td><tt class="docutils literal"><span class="pre">$00</span></tt></td><td><tt class="docutils literal"><span class="pre">FRELO1</span></tt></td><td>W</td><td>Voice 1 frequency, low 8 bits</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">$01</span></tt></td><td><tt class="docutils literal"><span class="pre">FREHI1</span></tt></td><td>W</td><td>Voice 1 frequency, high 8 bits</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">$02</span></tt></td><td><tt class="docutils literal"><span class="pre">PWLO1</span></tt></td><td>W</td><td>Voice 1 pulse width, low 8 bits</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">$03</span></tt></td><td><tt class="docutils literal"><span class="pre">PWHI1</span></tt></td><td>W</td><td>Voice 1 pulse width, high 4 bits</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">$04</span></tt></td><td><tt class="docutils literal"><span class="pre">VCREG1</span></tt></td><td>W</td><td>Voice 1 control register</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">$05</span></tt></td><td><tt class="docutils literal"><span class="pre">ATDCY1</span></tt></td><td>W</td><td>Voice 1 attack/decay</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">$06</span></tt></td><td><tt class="docutils literal"><span class="pre">SUREL1</span></tt></td><td>W</td><td>Voice 1 sustain/release</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">$07</span></tt></td><td><tt class="docutils literal"><span class="pre">FRELO2</span></tt></td><td>W</td><td>Voice 2 frequency, low 8 bits</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">$08</span></tt></td><td><tt class="docutils literal"><span class="pre">FREHI2</span></tt></td><td>W</td><td>Voice 2 frequency, high 8 bits</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">$09</span></tt></td><td><tt class="docutils literal"><span class="pre">PWLO2</span></tt></td><td>W</td><td>Voice 2 pulse width, low 8 bits</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">$0A</span></tt></td><td><tt class="docutils literal"><span class="pre">PWHI2</span></tt></td><td>W</td><td>Voice 2 pulse width, high 4 bits</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">$0B</span></tt></td><td><tt class="docutils literal"><span class="pre">VCREG2</span></tt></td><td>W</td><td>Voice 2 control register</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">$0C</span></tt></td><td><tt class="docutils literal"><span class="pre">ATDCY2</span></tt></td><td>W</td><td>Voice 2 attack/decay</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">$0D</span></tt></td><td><tt class="docutils literal"><span class="pre">SUREL2</span></tt></td><td>W</td><td>Voice 2 sustain/release</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">$0E</span></tt></td><td><tt class="docutils literal"><span class="pre">FRELO3</span></tt></td><td>W</td><td>Voice 3 frequency, low 8 bits</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">$0F</span></tt></td><td><tt class="docutils literal"><span class="pre">FREHI3</span></tt></td><td>W</td><td>Voice 3 frequency, high 8 bits</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">$10</span></tt></td><td><tt class="docutils literal"><span class="pre">PWLO3</span></tt></td><td>W</td><td>Voice 3 pulse width, low 8 bits</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">$11</span></tt></td><td><tt class="docutils literal"><span class="pre">PWHI3</span></tt></td><td>W</td><td>Voice 3 pulse width, high 4 bits</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">$12</span></tt></td><td><tt class="docutils literal"><span class="pre">VCREG3</span></tt></td><td>W</td><td>Voice 3 control register</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">$13</span></tt></td><td><tt class="docutils literal"><span class="pre">ATDCY3</span></tt></td><td>W</td><td>Voice 3 attack/decay</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">$14</span></tt></td><td><tt class="docutils literal"><span class="pre">SUREL3</span></tt></td><td>W</td><td>Voice 3 sustain/release</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">$15</span></tt></td><td><tt class="docutils literal"><span class="pre">CUTLO</span></tt></td><td>W</td><td>Filter cutoff, low 3 bits</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">$16</span></tt></td><td><tt class="docutils literal"><span class="pre">CUTHI</span></tt></td><td>W</td><td>Filter cutoff, high 8 bits</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">$17</span></tt></td><td><tt class="docutils literal"><span class="pre">RESON</span></tt></td><td>W</td><td>Filter voice switching and resonance</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">$18</span></tt></td><td><tt class="docutils literal"><span class="pre">SIGVOL</span></tt></td><td>W</td><td>Master volume and filter mode</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">$19</span></tt></td><td><tt class="docutils literal"><span class="pre">POTX</span></tt></td><td>R</td><td>Potentiometer X current value</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">$1A</span></tt></td><td><tt class="docutils literal"><span class="pre">POTY</span></tt></td><td>R</td><td>Potentiometer Y current value</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">$1B</span></tt></td><td><tt class="docutils literal"><span class="pre">OSC3</span></tt></td><td>R</td><td>Voice 3 waveform generator output, high 8 bits</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">$1C</span></tt></td><td><tt class="docutils literal"><span class="pre">ENV3</span></tt></td><td>R</td><td>Voice 3 envelope generator output</td></tr>
</table>
<h2><a class="toc-backref" id="voices" href="#voices">Voices</a></h2><p>Each of the 6581's three voices consists of a waveform generator, an envelope generator, and an amplitude modulator. The waveform generator creates a sound wave of a particular shape at the requested frequency. The envelope generator creates a volume profile for each &quot;note&quot;, controlling the note's attack time, decay time, sustain level, and release time. The amplitude modulator then combines these two, making a waveform that varies in volume according to the envelope.</p>

<h3><a class="toc-backref" id="voices-waveform-generators" href="#voices-waveform-generators">Waveform Generators</a></h3><p>Each waveform generator starts with a 24-bit phase accumulating oscillator. This is a digital oscillator in which the 16-bit number held in <tt class="docutils literal"><span class="pre">FRELOx</span></tt> and <tt class="docutils literal"><span class="pre">FREHIx</span></tt> is added to the accumulator every clock cycle. Once the PAO reaches its max value, it rolls over to 0 and starts again. In this way, the <tt class="docutils literal"><span class="pre">FRELOx</span></tt> and <tt class="docutils literal"><span class="pre">FREHIx</span></tt> registers control the frequency of the oscillator; a higher number will cause the PAO to roll over more often, increasing its frequency.</p>
<p>The output of a PAO is therefore a digital sawtooth wave. In most applications, this output is fed to a lookup table which results in the value of a sine wave at that point in its phase (hence the name &quot;phase accumulating oscillator&quot;), but the 6581 doesn't have enough silicon to hold a lookup table. Instead, it uses logical manipulations to produce four waveforms that do not require lookup tables.</p>
<p>One of those waveforms is the sawtooth itself. The top 12 bits of the PAO output are passed along as the sawtooth output.</p>
<p>A triangle wave is produced by exclusive-oring the most significant bit of the PAO output with the next 11 bits. This causes those 11 bits to reverse when the MSB is high, turning the sawtooth into a triangle. These 11 bits are shifted to the left (and a 0 added as bit zero) to produce a triangle wave that has the same amplitude as the sawtooth but with half the resolution.</p>
<p>A pulse wave is produced with a comparator. The value of the top 12 bits of the PAO is compared with the contents of the pulse width registers <tt class="docutils literal"><span class="pre">PWLOx</span></tt> and <tt class="docutils literal"><span class="pre">PWHIx</span></tt> (the high 4 bits of <tt class="docutils literal"><span class="pre">PWHIx</span></tt> are ignored). If the register value is higher, the output is <tt class="docutils literal"><span class="pre">0xfff</span></tt>. If the PAO value is higher, the output is <tt class="docutils literal"><span class="pre">0x000</span></tt>. A square (pulse) wave is thus created that alternates at these two values at a rate depending on the frequency of the PAO's sawtooth, with the pulse width registers controlling the percentage of time that the waveform spends at the max value compared to the min value.</p>
<p>Finally, pseudo-random noise is produced by a separate 23-bit linear feedback shift register (LFSR). This shift register is clocked by bit 19 of the PAO, so the frequency of the noise can be controlled. The values of bits 17 and 22 are exclusive-ored and fed back to bit 0. The result is a completely deterministic set of bits that nonetheless &quot;looks&quot; random. Eight bits of this register are used as the output; four zeros are added as low bits to create a 12-bit noise waveform.</p>
<p>Selection of the waveforms is done with the <tt class="docutils literal"><span class="pre">VCREGx</span></tt> register, which looks like this:</p>
<table border="1" class="docutils"><tr><th>7</th><th>6</th><th>5</th><th>4</th><th>3</th><th>2</th><th>1</th><th>0</th></tr>
<tr><td><tt class="docutils literal"><span class="pre">NOISE</span></tt></td><td><tt class="docutils literal"><span class="pre">PULSE</span></tt></td><td><tt class="docutils literal"><span class="pre">SAWTOOTH</span></tt></td><td><tt class="docutils literal"><span class="pre">TRIANGLE</span></tt></td><td><tt class="docutils literal"><span class="pre">TEST</span></tt></td><td><tt class="docutils literal"><span class="pre">RING</span></tt></td><td><tt class="docutils literal"><span class="pre">SYNC</span></tt></td><td><tt class="docutils literal"><span class="pre">GATE</span></tt></td></tr>
</table><p>Bits 4-7 control the output waveform. More than one of these can be selected at a time; doing so is <em>supposed</em> to (by the documentation) logically and the bits of each waveform together. The reality was not so. Combining waveforms creates output that can't be accurately modelled; this emulator instead uses samples of actual 6581 output to create these &quot;combined waveforms&quot;.</p>
<p>The exception is noise; due to a flaw in the chip design (and there were a few; the 6581 was designed and produced with severe limits on time and silicon space), combining another waveform with the noise waveform causes the LFSR to fill with zeroes, resulting in zero output (and requiring that the chip be reset or the <tt class="docutils literal"><span class="pre">TEST</span></tt> bit to be set and cleared before noise can be produced again). This emulator simply returns a <tt class="docutils literal"><span class="pre">0</span></tt> value when combining noise.</p>
<p>The diagram above has four other bits hinting at other functions. The <tt class="docutils literal"><span class="pre">TEST</span></tt> bit causes normal operation of it is low, but if it is set to high, the PAO fills with zeroes, the LFSR fills with ones, and the pulse generator latches at max value. Returning <tt class="docutils literal"><span class="pre">TEST</span></tt> to low resumes normal operation (including resetting the LFSR so it doesn't simply continue to produce all <tt class="docutils literal"><span class="pre">1</span></tt>s).</p>
<p>The <tt class="docutils literal"><span class="pre">SYNC</span></tt> bit controls synching the PAO with another voice's PAO (the other voice is hardcoded; voice 1 used voice 3, voice 2 used voice 1, and voice 3 used voice 2). When the synched PAO's MSB transitions from <tt class="docutils literal"><span class="pre">0</span></tt> to <tt class="docutils literal"><span class="pre">1</span></tt>, the current PAO resets to zero no matter what value it is at. No other property of the synched PAO matters, only its frequency, so the synched voice can still be controlled to produce sound as normal. This mechanism allows for the production of much more complex waveforms than one PAO alone could do.</p>
<p>The <tt class="docutils literal"><span class="pre">RING</span></tt> bit controls ring modulation. Ring modulation is only used if the current PAO is set to the triangle waveform. In this case, the MSB of the synced PAO is <em>exclusive-ored</em> with the current PAO's value, meaning that the current PAO output reverses (like the triangle wave output) when the synched MSB is <tt class="docutils literal"><span class="pre">1</span></tt>. This can produce even more complex waveforms with a wide range of non-harmonic overtones that can be used for creating special effects, including gongs and bells.</p>
<p>The <tt class="docutils literal"><span class="pre">GATE</span></tt> bit has no effect on the waveform generator; it is used by the envelope generator that is discussed next.</p>
<p>The high 8 bits of voice 3's waveform generator output are made available in the <tt class="docutils literal"><span class="pre">OSC3</span></tt> register. This register has often also been called something like <tt class="docutils literal"><span class="pre">RANDOM</span></tt> and has been so named because it's common usage to apply a <tt class="docutils literal"><span class="pre">NOISE</span></tt> waveform to voice 3 and then use this register to generate pseudo-random numbers. The waveform is available here even if the voice is not used, because it's never gated (see the <tt class="docutils literal"><span class="pre">GATE</span></tt> bit of the envelope generator below) or because it's disconnected (see the <tt class="docutils literal"><span class="pre">DSCNV3</span></tt> bit in the filter discussion even further below).</p>

<h3><a class="toc-backref" id="voices-envelope-generator" href="#voices-envelope-generator">Envelope Generator</a></h3><p>Each envelope generator is a simple circuit that produces a value from 0x00 to 0xff on every clock cycle. This value behaves in a way determined by the phase that the envelope generator is in at the time: either attack, decay, sustain, or release. The result is an &quot;envelope&quot;, a volume profile that controls the way each note is shaped.</p>
<p>The attack phase begins when the <tt class="docutils literal"><span class="pre">GATE</span></tt> bit of the <tt class="docutils literal"><span class="pre">VCREGx</span></tt> register (seen in the diagram just above) is set to <tt class="docutils literal"><span class="pre">1</span></tt>. The envelope output starts at 0x00 and rises to 0xff at a rate determined by the high 4 bits of the <tt class="docutils literal"><span class="pre">ATDCYx</span></tt> register, according to the following table:</p>
<table border="1" class="docutils"><tr><th>Value</th><th>Attack rate</th></tr>
<tr><td><tt class="docutils literal"><span class="pre">$0</span></tt></td><td>2 ms</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">$1</span></tt></td><td>8 ms</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">$2</span></tt></td><td>16 ms</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">$3</span></tt></td><td>24 ms</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">$4</span></tt></td><td>38 ms</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">$5</span></tt></td><td>56 ms</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">$6</span></tt></td><td>68 ms</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">$7</span></tt></td><td>80 ms</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">$8</span></tt></td><td>100 ms</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">$9</span></tt></td><td>250 ms</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">$A</span></tt></td><td>500 ms</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">$B</span></tt></td><td>800 ms</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">$C</span></tt></td><td>1 s</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">$D</span></tt></td><td>3 s</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">$E</span></tt></td><td>5 s</td></tr>
<tr><td><tt class="docutils literal"><span class="pre">$F</span></tt></td><td>8 s</td></tr>
</table><p>Once the envelope output reaches <tt class="docutils literal"><span class="pre">0xff</span></tt>, the decay phase begins. In this phase, the envelope output falls at a rate determined by the low 4 bits of the <tt class="docutils literal"><span class="pre">ATDCYx</span></tt> register, according to the table above. However, at various points, the decay rate slows. This is used to produce a smooth curve from the max value to zero, and it results in the decay (and release, see below) phases taking potentially three times as long as the table above.</p>
<p>The decay continues until the envelope output reaches the sustain level, set by the high 4 bits of the <tt class="docutils literal"><span class="pre">SURELx</span></tt> register. (Note that unlike attack and decay, this setting does not control a <em>time</em>, it controls a <em>level</em>.) The actual sustain value is derived by doubling the hexadecimal digit set in the register; setting sustain to <tt class="docutils literal"><span class="pre">$C</span></tt>, for instance, would cause the decay phase to end and the sustain phase to begin once the envelope output falls to <tt class="docutils literal"><span class="pre">0xcc</span></tt>. Nothing terribly interesting happens in the sustain phase; the envelope output simply stays at the same level.</p>
<p>This phase transitions into the release phase when the <tt class="docutils literal"><span class="pre">GATE</span></tt> bit of the <tt class="docutils literal"><span class="pre">VCREGx</span></tt> register is set to <tt class="docutils literal"><span class="pre">0</span></tt>. The release phase is mechanically exactly the same as the decay phase, except that it makes the envelope output decrement all the way to zero rather than to the sustain level. The rate at which this happens is controlled by the low 4 bits of the <tt class="docutils literal"><span class="pre">SURELx</span></tt> register.</p>
<p>The result is a volume profile that is meant to sound more natural than simply turning a waveform on and off to produce a note. It can be used to simulate a number of different instruments, from an organ (min attack and release, max sustain) to a percussion instrument (min attack, decay fast for a drum or slow for a cymbal, zero sustain). It can also be used to produce more unusual effects, such as the reverse envelope (slow attack, max sustain, fast release).</p>
<p>The envelope generator has a couple of important bugs that were exploited by software engineers and thus need to be emulated as well. The most famous is the ADSR delay bug. This bug manifests when an attack, decay, or release value is reset in the middle of its phase to a number that has already passed. For example, if the attack is set initially to 250ms, and then after half that time it gets reset to 100ms, this bug would happen. The attack does not immediately stop and move into the decay phase; instead, the internal counter that controls each phase must reach its max value, wrap to zero, and <em>then</em> reach the new value before the attack will end. This can cause significant enough delays in phase transitions to be audible, and it would be used by programmers to create interesting sounds.</p>
<p>Another bug skirts the design that once the envelope value does not wrap around once it reaches zero. In this case, if an attack is started by setting the <tt class="docutils literal"><span class="pre">GATE</span></tt> bit, and that <tt class="docutils literal"><span class="pre">GATE</span></tt> bit is immediately cleared while the envelope output is still zero (starting the release phase), then the envelope generator <em>will</em> wrap around, basically starting a release phase from <tt class="docutils literal"><span class="pre">0xff</span></tt> rather than just doing nothing as it should have.</p>
<p>The output of voice 3's envelope generator is made available in the <tt class="docutils literal"><span class="pre">ENV3</span></tt> register.</p>

<h3><a class="toc-backref" id="voices-amplitude-modulator" href="#voices-amplitude-modulator">Amplitude modulator</a></h3><p>The amplitude modulator basically multiplies the outputs of the waveform and envelope generators. The result is the waveform produced by the waveform generator, with its volume controlled by the envelope produced by the envelope generator. There is no control for the amplitude modulator, and in this emulation, it does not merit a separate file of code (it's embedded into the voice code).</p>

<h2><a class="toc-backref" id="filterslashmixer" href="#filterslashmixer">Filter/mixer</a></h2><p>The 6581 also features a single programmable filter. Each voice can either skip the filter or be routed through it, and an additional external input (from the <tt class="docutils literal"><span class="pre">EXT</span></tt> pin) can be controlled in the same way. Whether or not these four inputs are filtered, they are all combined in a mixer at the end which produces the final output.</p>
<p>The 6581's filter is an analog filter, but since we don't have the capability of being analog in a computer program, it is emulated digitally. The filter's mode, cutoff frequency, and resonance can be changed, along with the selection of voices that are routed through it, and these are all controlled by four registers.</p>
<p>The cutoff frequency is controlled by the <tt class="docutils literal"><span class="pre">CUTLO</span></tt> and <tt class="docutils literal"><span class="pre">CUTHI</span></tt> registers. This renders an 11-bit number (the top 5 bits of <tt class="docutils literal"><span class="pre">CUTLO</span></tt> are ignored) that determines the frequency at which the filter begins to work - if set to low-pass, this is the frequency above which volume is lowered; if set to high-pass, this is the frequency <em>below</em> which volume is lowered; and if set to band-pass, this is the center of the frequencies that are passed through unimpeded while both lower <em>and</em> higher frequencies are suppressed.</p>
<p>The values in <tt class="docutils literal"><span class="pre">CUTLO</span></tt> and <tt class="docutils literal"><span class="pre">CUTHI</span></tt> do not determine the cutoff frequency directly. In fact, the curve for frequencies depending on the register setting is complex and even has a discontinuiuty at one point. The cutoff frequency starts at about 220Hz at register value zero and rises, slowly at first, and then much more quickly as it approaches the halfway register value of <tt class="docutils literal"><span class="pre">$3FF</span></tt>; at <tt class="docutils literal"><span class="pre">$3FF</span></tt>, the frequency is about 6kHz. Then there is a sudden drop to about 4.6kHz at register value <tt class="docutils literal"><span class="pre">$400</span></tt>. The frequency then again rises, uickly at first and then slower as it approaches the max register value of <tt class="docutils literal"><span class="pre">$7FF</span></tt>, where the cutoff frequency is about 18kHz. There is no particular model to these values, and they vary slightly between chips; the values in this emulator are interpolated from 27 sample values taken from a physical 6581 chip.</p>
<p>The cutoff frequency values also depend on the two capacitors external to the chip. One is attached across <tt class="docutils literal"><span class="pre">CAP1A</span></tt> and <tt class="docutils literal"><span class="pre">CAP1B</span></tt>, while the other is connected to <tt class="docutils literal"><span class="pre">CAP2A</span></tt> and <tt class="docutils literal"><span class="pre">CAP2B</span></tt>. The values selected here assume 470pF capacitors across these pins, as was the case in the Commodore 64. The CAP pins are otherwise not emulated.</p>
<p>The other two filter/mixer-related registers have multiple purposes. The <tt class="docutils literal"><span class="pre">RESON</span></tt> register controls resonance and which voices are actually filtered:</p>
<table border="1" class="docutils"><tr><th>7</th><th>6</th><th>5</th><th>4</th><th>3</th><th>2</th><th>1</th><th>0</th></tr>
<tr><td><tt class="docutils literal"><span class="pre">RES3</span></tt></td><td><tt class="docutils literal"><span class="pre">RES2</span></tt></td><td><tt class="docutils literal"><span class="pre">RES1</span></tt></td><td><tt class="docutils literal"><span class="pre">RES0</span></tt></td><td><tt class="docutils literal"><span class="pre">FILTEX</span></tt></td><td><tt class="docutils literal"><span class="pre">FILTV3</span></tt></td><td><tt class="docutils literal"><span class="pre">FILTV2</span></tt></td><td><tt class="docutils literal"><span class="pre">FILTV1</span></tt></td></tr>
</table><p>Bits 4-7 control the resonance, which essentially causes frequencies near the cutoff frequency to be <em>amplified</em> before being attentuated beyond the cutoff frequency. This was an undesirable artifact in filters originally, but it became useful particularly for sound effects and so is often a feature in modern filters. A higher value for resonance will cause frequencies near the cutoff frequency to be amplified more.</p>
<p>Bits 0-3 control which voices are sent through the filter in the first place; there is one bit for each voice, plus an additional bit to control whether the external input is filtered. (The external input is not otherwise controllable; it is either filtered or not, and then it's mixed with the signals from the three voices before being output.)</p>
<p>The type of filter is determined by the settings in the final filter register, <tt class="docutils literal"><span class="pre">SIGVOL</span></tt>:</p>
<table border="1" class="docutils"><tr><th>7</th><th>6</th><th>5</th><th>4</th><th>3</th><th>2</th><th>1</th><th>0</th></tr>
<tr><td><tt class="docutils literal"><span class="pre">DSCNV3</span></tt></td><td><tt class="docutils literal"><span class="pre">FILTHP</span></tt></td><td><tt class="docutils literal"><span class="pre">FILTBP</span></tt></td><td><tt class="docutils literal"><span class="pre">FILTLP</span></tt></td><td><tt class="docutils literal"><span class="pre">VOL3</span></tt></td><td><tt class="docutils literal"><span class="pre">VOL2</span></tt></td><td><tt class="docutils literal"><span class="pre">VOL1</span></tt></td><td><tt class="docutils literal"><span class="pre">VOL0</span></tt></td></tr>
</table><p>Bits 4-6 control the filter mode, which is either high-pass, band-pass, or low-pass. These modes can be combined (though they must share their cutoff frequencies and resonances); a common way to do this is to create a &quot;notch filter&quot; by combining high-pass and low-pass filters that reject frequencies near the cutoff frequency in a manner opposite to that of a band-pass filter.</p>
<p>Bit 7 allows voice 3 to be disconnected entirely. This is only possible if voice 3 is <em>not</em> routed through the filter; if it is, the setting of this bit is ignored. This option lets voice 3 be used simply for synching or ring modulation without actually contributing sound to the output.</p>
<p>The other four bits (0-3) control the master volume of the mixer. All four signals, whether they are filtered or unfiltered, are combined by a mixer and the final volume of that mixer is controlled by these four bits.</p>

<h2><a class="toc-backref" id="external-filter" href="#external-filter">External filter</a></h2><p>In the physical 6581, the signal that comes out of the mixer is sent directly to the <tt class="docutils literal"><span class="pre">AUDIO</span></tt> output pin. However, in the Commodore 64, this pin is connected to another filter external to the 6581, and the output of that filter is actually sent to the audio/video connector. For the sake of convenience, that external filter is emulated directly in this Ic6581 type.</p>
<p>The external filter is a simple pair of RC filters that is tuned to pass frequencies between 16Hz and 16kHz. It is completely passive, neither tunable or otherwise controllable (including that it can't be disabled).</p>

<h2><a class="toc-backref" id="potentiometers" href="#potentiometers">Potentiometers</a></h2><p>Completely unrelated to sound production, the 6581 also dedicates two pins and two registers to potentiometer reading. In practice, these potentiometers are almost always game paddles, though there is nothing preventing them from being any other kind of device that can send a varying voltage to the <tt class="docutils literal"><span class="pre">POTX</span></tt> and <tt class="docutils literal"><span class="pre">POTY</span></tt> pins (via Control Ports 1 and 2).</p>
<p>The physical 6581 expects these to be RC circuits that charge a capacitor at a varying rate depending on the value of the resistor (which is a variable resistor - a potentiometer - that is normally the game paddle itself). The 6581 circuitry reads the capacitor discharge time and translates it to a value between <tt class="docutils literal"><span class="pre">0x00</span></tt> and <tt class="docutils literal"><span class="pre">0xff</span></tt>, which is then made available in the appropriate register (<tt class="docutils literal"><span class="pre">POTXR</span></tt> register for <tt class="docutils literal"><span class="pre">POTX</span></tt> pin, and <tt class="docutils literal"><span class="pre">POTYR</span></tt> register for <tt class="docutils literal"><span class="pre">POTY</span></tt> pin). This process takes 512 clock cycles, so the values of the registers update that often.</p>
<p>In this emulation, physical processes like capacitor discharge are not modelled, so the values on the <tt class="docutils literal"><span class="pre">POTX</span></tt> and <tt class="docutils literal"><span class="pre">POTY</span></tt> pins are simply reflected in their registers (after dropping any bits above the eighth). The registers still only update every 512 cycles to be consistent with that original behavior.</p>

<h2><a class="toc-backref" id="readminusonly-versus-writeminusonly-registers" href="#readminusonly-versus-writeminusonly-registers">Read-only versus write-only registers</a></h2><p>The 6581 is unusual in that it has no registers that can be both read and written. The <tt class="docutils literal"><span class="pre">POTX</span></tt>, <tt class="docutils literal"><span class="pre">POTY</span></tt>, <tt class="docutils literal"><span class="pre">OSC3</span></tt>, and <tt class="docutils literal"><span class="pre">ENV3</span></tt> registers are read-only; attempting to write to these registers has no effect. All of the other registers are write-only, and attempting to read them is handled a bit strangely.</p>
<p>When a register is written to in a physical 6581, the value on the data pins lingers on the internal data bus for a time. An attempt to read a write-only register would then result in that value, no matter which register had been written and no matter which write-only register has a read attempted on it. This value on the internal data bus would decay over time, causing bits to switch to zero at unpredictable times over the course of about two milliseconds. Since that unpredicable behavior is impossible to model (it's different on every 6581), the choice here is to return the last written value on any read of a write-only register, unless it's been more than 2000 clock cycles since the last write. In that case, a zero is returned.</p>

<h2><a class="toc-backref" id="pin-interface" href="#pin-interface">Pin interface</a></h2><p>The vast majority of interaction with the 6581 is done through setting registers to certain values. The main output only takes up one pin. For this reason, despite the complexity of the chip internally, it can comfortably fit in a 28-pin package.</p>
<p><pre class="listing">
           +-----+--+-----+
     CAP1A |1    +--+   28| VDD
     CAP1B |2           27| AUDIO
     CAP2A |3           26| EXT
     CAP2B |4           25| VCC
       RES |5           24| POTX
      PHI2 |6           23| POTY
       R_W |7           22| D7
        CS |8    6581   21| D6
        A0 |9           20| D5
        A1 |10          19| D4
        A2 |11          18| D3
        A3 |12          17| D2
        A4 |13          16| D1
       GND |14          15| D0
           +--------------+
</pre> Some names are changed from the datasheet, aside from the regular switch from Ï†2 to PHI2. POTX and POTY are called POT X and POT Y respectively, and the audio pins are called EXT IN and AUDIO OUT. These are all changed here because spaces are inconvenient.</p>
<p>Pin assignments are explained below.</p>
<table border="1" class="docutils"><tr><th>Pin</th><th>Name</th><th>Description</th></tr>
<tr><td>1</td><td><tt class="docutils literal"><span class="pre">CAP1A</span></tt></td><td>Connection for filter capacitor 1, not emulated.</td></tr>
<tr><td>2</td><td><tt class="docutils literal"><span class="pre">CAP1B</span></tt></td><td>Connection for filter capacitor 1, not emulated.</td></tr>
<tr><td>3</td><td><tt class="docutils literal"><span class="pre">CAP2A</span></tt></td><td>Connection for filter capacitor 2, not emulated.</td></tr>
<tr><td>4</td><td><tt class="docutils literal"><span class="pre">CAP2B</span></tt></td><td>Connection for filter capacitor 2, not emulated.</td></tr>
<tr><td>5</td><td><tt class="docutils literal"><span class="pre">RES</span></tt></td><td>Reset. When this goes low, the chip resets.</td></tr>
<tr><td>6</td><td><tt class="docutils literal"><span class="pre">PHI2</span></tt></td><td>Clock input. Should be 1MHz; other values will shift audio frequencies.</td></tr>
<tr><td>7</td><td><tt class="docutils literal"><span class="pre">R_W</span></tt></td><td>Read (<tt class="docutils literal"><span class="pre">1</span></tt>) and write (<tt class="docutils literal"><span class="pre">0</span></tt>) control for the registers.</td></tr>
<tr><td>8</td><td><tt class="docutils literal"><span class="pre">CS</span></tt></td><td>Chip select. Must be low to read or write registers.</td></tr>
<tr><td>9</td><td><tt class="docutils literal"><span class="pre">A0</span></tt></td><td>Address pin 0.</td></tr>
<tr><td>10</td><td><tt class="docutils literal"><span class="pre">A1</span></tt></td><td>Address pin 1.</td></tr>
<tr><td>11</td><td><tt class="docutils literal"><span class="pre">A2</span></tt></td><td>Address pin 2.</td></tr>
<tr><td>12</td><td><tt class="docutils literal"><span class="pre">A3</span></tt></td><td>Address pin 3.</td></tr>
<tr><td>13</td><td><tt class="docutils literal"><span class="pre">A4</span></tt></td><td>Address pin 4.</td></tr>
<tr><td>14</td><td><tt class="docutils literal"><span class="pre">GND</span></tt></td><td>Electrical ground. Not emulated.</td></tr>
<tr><td>15</td><td><tt class="docutils literal"><span class="pre">D0</span></tt></td><td>Data pin 0.</td></tr>
<tr><td>16</td><td><tt class="docutils literal"><span class="pre">D1</span></tt></td><td>Data pin 1.</td></tr>
<tr><td>17</td><td><tt class="docutils literal"><span class="pre">D2</span></tt></td><td>Data pin 2.</td></tr>
<tr><td>18</td><td><tt class="docutils literal"><span class="pre">D3</span></tt></td><td>Data pin 3.</td></tr>
<tr><td>19</td><td><tt class="docutils literal"><span class="pre">D4</span></tt></td><td>Data pin 4.</td></tr>
<tr><td>20</td><td><tt class="docutils literal"><span class="pre">D5</span></tt></td><td>Data pin 5.</td></tr>
<tr><td>21</td><td><tt class="docutils literal"><span class="pre">D6</span></tt></td><td>Data pin 6.</td></tr>
<tr><td>22</td><td><tt class="docutils literal"><span class="pre">D7</span></tt></td><td>Data pin 7.</td></tr>
<tr><td>23</td><td><tt class="docutils literal"><span class="pre">POTY</span></tt></td><td>Potentiometer Y input.</td></tr>
<tr><td>24</td><td><tt class="docutils literal"><span class="pre">POTX</span></tt></td><td>Potentiometer X input.</td></tr>
<tr><td>25</td><td><tt class="docutils literal"><span class="pre">VCC</span></tt></td><td>+5V power supply. Not emulated.</td></tr>
<tr><td>26</td><td><tt class="docutils literal"><span class="pre">EXT</span></tt></td><td>External audio input.</td></tr>
<tr><td>27</td><td><tt class="docutils literal"><span class="pre">AUDIO</span></tt></td><td>Audio output.</td></tr>
<tr><td>28</td><td><tt class="docutils literal"><span class="pre">VDD</span></tt></td><td>+12V power supply. Not emulated.</td></tr>
</table><p>Pins <tt class="docutils literal"><span class="pre">POTX</span></tt>, <tt class="docutils literal"><span class="pre">POTY</span></tt>, <tt class="docutils literal"><span class="pre">EXT</span></tt>, and <tt class="docutils literal"><span class="pre">AUDIO</span></tt> are all analog pins. <tt class="docutils literal"><span class="pre">POTX</span></tt> and <tt class="docutils literal"><span class="pre">POTY</span></tt> expect values from <tt class="docutils literal"><span class="pre">0x00</span></tt> to <tt class="docutils literal"><span class="pre">0xff</span></tt> on them; if higher values are applied to these pins, the top bits will be left off until there are 8 left. <tt class="docutils literal"><span class="pre">AUDIO</span></tt> is approximately 20 bits wide, and <tt class="docutils literal"><span class="pre">EXT</span></tt> should be about the same to mix evenly with the generated audio.</p>
<p>In the Commodore 64, U18 is a 6581. It responds to addresses from <tt class="docutils literal"><span class="pre">$D400</span></tt> to <tt class="docutils literal"><span class="pre">$D7FF</span></tt>. This is many more addresses than are necessary to accomodate the 29 registers that are actually present. These registers repeat every 32 (<tt class="docutils literal"><span class="pre">$20</span></tt>) addresses through that space. For example, writing <tt class="docutils literal"><span class="pre">$D400</span></tt>, <tt class="docutils literal"><span class="pre">$D420</span></tt>, <tt class="docutils literal"><span class="pre">$D440</span></tt>, etc. will all write to the <tt class="docutils literal"><span class="pre">FRELO1</span></tt> register, and reading <tt class="docutils literal"><span class="pre">$D419</span></tt>, <tt class="docutils literal"><span class="pre">$D439</span></tt>, <tt class="docutils literal"><span class="pre">$D459</span></tt>, etc. will all read from the <tt class="docutils literal"><span class="pre">POTX</span></tt> register. It's recommended to ignore this &quot;feature&quot; and just read from/write to the lowest address (<tt class="docutils literal"><span class="pre">$D400</span></tt> and <tt class="docutils literal"><span class="pre">$D419</span></tt> in these examples).</p>
<p>R7, R38, C13, C37, and Q8 make up the external filter that is not a part of the physical chip but that is emulated by this type.</p>
</p>
  <div class="section" id="6">
<h1><a class="toc-backref" href="#6">Imports</a></h1>
<dl class="item">
<a class="reference external" href="../utils.html">../utils</a>, <a class="reference external" href="../components/chip.html">../components/chip</a>, <a class="reference external" href="../components/link.html">../components/link</a>, <a class="reference external" href="ic6581/voice.html">ic6581/voice</a>, <a class="reference external" href="ic6581/filter.html">ic6581/filter</a>, <a class="reference external" href="ic6581/external.html">ic6581/external</a>, <a class="reference external" href="ic6581/constants.html">ic6581/constants</a>, <a class="reference external" href="../components/pins.html">../components/pins</a>, <a class="reference external" href="../components/registers.html">../components/registers</a>
</dl></div>
<div class="section" id="7">
<h1><a class="toc-backref" href="#7">Types</a></h1>
<dl class="item">
<a id="Ic6581"></a>
<dt><pre><a href="ic6581.html#Ic6581"><span class="Identifier">Ic6581</span></a> <span class="Other">=</span> <span class="Keyword">ref</span> <span class="Keyword">object</span>
  <span class="Identifier">pins</span><span class="Other">:</span> <a href="../components/pins.html#Pins"><span class="Identifier">Pins</span></a>
  <span class="Identifier">registers</span><span class="Other">:</span> <a href="../components/registers.html#Registers"><span class="Identifier">Registers</span></a>
</pre></dt>
<dd>



</dd>

</dl></div>
<div class="section" id="12">
<h1><a class="toc-backref" href="#12">Procs</a></h1>
<dl class="item">
<a id="registers,Ic6581"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#registers%2CIc6581"><span class="Identifier">registers</span></a><span class="Other">(</span><span class="Identifier">chip`gensym1</span><span class="Other">:</span> <a href="ic6581.html#Ic6581"><span class="Identifier">Ic6581</span></a><span class="Other">)</span><span class="Other">:</span> <span class="Identifier">seq</span><span class="Other">[</span><a href="../components/registers.html#RegisterInfo"><span class="Identifier">RegisterInfo</span></a><span class="Other">]</span> <span><span class="Other">{</span><span class="Other pragmadots">...</span><span class="Other">}</span></span><span class="pragmawrap"><span class="Other">{.</span><span class="pragma"><span class="Identifier">raises</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span><span class="Other">,</span> <span class="Identifier">tags</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span></span><span class="Other">.}</span></span></pre></dt>
<dd>

Returns a read-only view of the chip's registers.

</dd>
<a id="[],Ic6581,int"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#%5B%5D%2CIc6581%2Cint"><span class="Identifier">`[]`</span></a><span class="Other">(</span><span class="Identifier">chip`gensym0</span><span class="Other">:</span> <a href="ic6581.html#Ic6581"><span class="Identifier">Ic6581</span></a><span class="Other">;</span> <span class="Identifier">index`gensym0</span><span class="Other">:</span> <span class="Identifier">int</span><span class="Other">)</span><span class="Other">:</span> <a href="../components/link.html#Pin"><span class="Identifier">Pin</span></a> <span><span class="Other">{</span><span class="Other pragmadots">...</span><span class="Other">}</span></span><span class="pragmawrap"><span class="Other">{.</span><span class="pragma"><span class="Identifier">inline</span><span class="Other">,</span> <span class="Identifier">raises</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span><span class="Other">,</span>
    <span class="Identifier">tags</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span></span><span class="Other">.}</span></span></pre></dt>
<dd>

Looks up a pin by the pin's number.

</dd>
<a id="[],Ic6581,string"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#%5B%5D%2CIc6581%2Cstring"><span class="Identifier">`[]`</span></a><span class="Other">(</span><span class="Identifier">chip`gensym0</span><span class="Other">:</span> <a href="ic6581.html#Ic6581"><span class="Identifier">Ic6581</span></a><span class="Other">;</span> <span class="Identifier">index`gensym0</span><span class="Other">:</span> <span class="Identifier">string</span><span class="Other">)</span><span class="Other">:</span> <a href="../components/link.html#Pin"><span class="Identifier">Pin</span></a> <span><span class="Other">{</span><span class="Other pragmadots">...</span><span class="Other">}</span></span><span class="pragmawrap"><span class="Other">{.</span><span class="pragma"><span class="Identifier">inline</span><span class="Other">,</span>
    <span class="Identifier">raises</span><span class="Other">:</span> <span class="Other">[</span><span class="Identifier">KeyError</span><span class="Other">]</span><span class="Other">,</span> <span class="Identifier">tags</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span></span><span class="Other">.}</span></span></pre></dt>
<dd>

Looks up a pin by the pin's name.

</dd>
<a id="pins,Ic6581"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#pins%2CIc6581"><span class="Identifier">pins</span></a><span class="Other">(</span><span class="Identifier">chip`gensym0</span><span class="Other">:</span> <a href="ic6581.html#Ic6581"><span class="Identifier">Ic6581</span></a><span class="Other">)</span><span class="Other">:</span> <span class="Identifier">seq</span><span class="Other">[</span><a href="../components/pins.html#PinInfo"><span class="Identifier">PinInfo</span></a><span class="Other">]</span> <span><span class="Other">{</span><span class="Other pragmadots">...</span><span class="Other">}</span></span><span class="pragmawrap"><span class="Other">{.</span><span class="pragma"><span class="Identifier">raises</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span><span class="Other">,</span> <span class="Identifier">tags</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span></span><span class="Other">.}</span></span></pre></dt>
<dd>

Returns a read-only view of the chip's pins.

</dd>
<a id="newIc6581"></a>
<dt><pre><span class="Keyword">proc</span> <a href="#newIc6581"><span class="Identifier">newIc6581</span></a><span class="Other">(</span><span class="Other">)</span><span class="Other">:</span> <a href="ic6581.html#Ic6581"><span class="Identifier">Ic6581</span></a> <span><span class="Other">{</span><span class="Other pragmadots">...</span><span class="Other">}</span></span><span class="pragmawrap"><span class="Other">{.</span><span class="pragma"><span class="Identifier">raises</span><span class="Other">:</span> <span class="Other">[</span><span class="Identifier">Exception</span><span class="Other">,</span> <span class="Identifier">KeyError</span><span class="Other">,</span> <span class="Identifier">ValueError</span><span class="Other">]</span><span class="Other">,</span>
                           <span class="Identifier">tags</span><span class="Other">:</span> <span class="Other">[</span><span class="Identifier">RootEffect</span><span class="Other">]</span></span><span class="Other">.}</span></span></pre></dt>
<dd>



</dd>

</dl></div>
<div class="section" id="15">
<h1><a class="toc-backref" href="#15">Iterators</a></h1>
<dl class="item">
<a id="items.i,Ic6581"></a>
<dt><pre><span class="Keyword">iterator</span> <a href="#items.i%2CIc6581"><span class="Identifier">items</span></a><span class="Other">(</span><span class="Identifier">chip`gensym0</span><span class="Other">:</span> <a href="ic6581.html#Ic6581"><span class="Identifier">Ic6581</span></a><span class="Other">)</span><span class="Other">:</span> <a href="../components/link.html#Pin"><span class="Identifier">Pin</span></a> <span><span class="Other">{</span><span class="Other pragmadots">...</span><span class="Other">}</span></span><span class="pragmawrap"><span class="Other">{.</span><span class="pragma"><span class="Identifier">raises</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span><span class="Other">,</span> <span class="Identifier">tags</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span></span><span class="Other">.}</span></span></pre></dt>
<dd>

Iterates over the chip's pins, yielding them in order by pin number.

</dd>
<a id="pairs.i,Ic6581"></a>
<dt><pre><span class="Keyword">iterator</span> <a href="#pairs.i%2CIc6581"><span class="Identifier">pairs</span></a><span class="Other">(</span><span class="Identifier">chip`gensym0</span><span class="Other">:</span> <a href="ic6581.html#Ic6581"><span class="Identifier">Ic6581</span></a><span class="Other">)</span><span class="Other">:</span> <span class="Other">(</span><span class="Identifier">int</span><span class="Other">,</span> <a href="../components/link.html#Pin"><span class="Identifier">Pin</span></a><span class="Other">)</span> <span><span class="Other">{</span><span class="Other pragmadots">...</span><span class="Other">}</span></span><span class="pragmawrap"><span class="Other">{.</span><span class="pragma"><span class="Identifier">raises</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span><span class="Other">,</span> <span class="Identifier">tags</span><span class="Other">:</span> <span class="Other">[</span><span class="Other">]</span></span><span class="Other">.}</span></span></pre></dt>
<dd>

Iterates over the chip's pins, yielding both the pin number and the pin itself.

</dd>

</dl></div>
<div class="section" id="19">
<h1><a class="toc-backref" href="#19">Exports</a></h1>
<dl class="item">
<a href="ic6581/constants.html#D5"><span class="Identifier">D5</span></a>, <a href="ic6581/constants.html#CUTHI"><span class="Identifier">CUTHI</span></a>, <a href="ic6581/constants.html#D2"><span class="Identifier">D2</span></a>, <a href="ic6581/constants.html#VDD"><span class="Identifier">VDD</span></a>, <a href="ic6581/constants.html#VCREG1"><span class="Identifier">VCREG1</span></a>, <a href="ic6581/constants.html#GATE"><span class="Identifier">GATE</span></a>, <a href="ic6581/constants.html#A2"><span class="Identifier">A2</span></a>, <a href="ic6581/constants.html#FREHI3"><span class="Identifier">FREHI3</span></a>, <a href="ic6581/constants.html#SIGVOL"><span class="Identifier">SIGVOL</span></a>, <a href="ic6581/constants.html#ATDCY1"><span class="Identifier">ATDCY1</span></a>, <a href="ic6581/constants.html#R_W"><span class="Identifier">R_W</span></a>, <a href="ic6581/constants.html#D1"><span class="Identifier">D1</span></a>, <a href="ic6581/constants.html#VCC"><span class="Identifier">VCC</span></a>, <a href="ic6581/constants.html#D0"><span class="Identifier">D0</span></a>, <a href="ic6581/constants.html#FREHI1"><span class="Identifier">FREHI1</span></a>, <a href="ic6581/constants.html#POTYR"><span class="Identifier">POTYR</span></a>, <a href="ic6581/constants.html#D3"><span class="Identifier">D3</span></a>, <a href="ic6581/constants.html#ATDCY2"><span class="Identifier">ATDCY2</span></a>, <a href="ic6581/constants.html#CS"><span class="Identifier">CS</span></a>, <a href="ic6581/constants.html#DSCNV3"><span class="Identifier">DSCNV3</span></a>, <a href="ic6581/constants.html#SYNC"><span class="Identifier">SYNC</span></a>, <a href="ic6581/constants.html#PWLO1"><span class="Identifier">PWLO1</span></a>, <a href="ic6581/constants.html#VCREG2"><span class="Identifier">VCREG2</span></a>, <a href="ic6581/constants.html#POTX"><span class="Identifier">POTX</span></a>, <a href="ic6581/constants.html#FILTBP"><span class="Identifier">FILTBP</span></a>, <a href="ic6581/constants.html#FILTV2"><span class="Identifier">FILTV2</span></a>, <a href="ic6581/constants.html#PWLO2"><span class="Identifier">PWLO2</span></a>, <a href="ic6581/constants.html#AUDIO"><span class="Identifier">AUDIO</span></a>, <a href="ic6581/constants.html#RESON"><span class="Identifier">RESON</span></a>, <a href="ic6581/constants.html#SAWTOOTH"><span class="Identifier">SAWTOOTH</span></a>, <a href="ic6581/constants.html#A1"><span class="Identifier">A1</span></a>, <a href="ic6581/constants.html#FRELO2"><span class="Identifier">FRELO2</span></a>, <a href="ic6581/constants.html#D4"><span class="Identifier">D4</span></a>, <a href="ic6581/constants.html#FILTV1"><span class="Identifier">FILTV1</span></a>, <a href="ic6581/constants.html#ATDCY3"><span class="Identifier">ATDCY3</span></a>, <a href="ic6581/constants.html#POTY"><span class="Identifier">POTY</span></a>, <a href="ic6581/constants.html#PWLO3"><span class="Identifier">PWLO3</span></a>, <a href="ic6581/constants.html#FILTLP"><span class="Identifier">FILTLP</span></a>, <a href="ic6581/constants.html#FILTV3"><span class="Identifier">FILTV3</span></a>, <a href="ic6581/constants.html#CAP1B"><span class="Identifier">CAP1B</span></a>, <a href="ic6581/constants.html#TEST"><span class="Identifier">TEST</span></a>, <a href="ic6581/constants.html#A0"><span class="Identifier">A0</span></a>, <a href="ic6581/constants.html#CAP2B"><span class="Identifier">CAP2B</span></a>, <a href="ic6581/constants.html#A3"><span class="Identifier">A3</span></a>, <a href="ic6581/constants.html#UNUSED3"><span class="Identifier">UNUSED3</span></a>, <a href="ic6581/constants.html#RES"><span class="Identifier">RES</span></a>, <a href="ic6581/constants.html#FILTHP"><span class="Identifier">FILTHP</span></a>, <a href="ic6581/constants.html#PWHI3"><span class="Identifier">PWHI3</span></a>, <a href="ic6581/constants.html#TRIANGLE"><span class="Identifier">TRIANGLE</span></a>, <a href="ic6581/constants.html#PHI2"><span class="Identifier">PHI2</span></a>, <a href="ic6581/constants.html#FILTEXT"><span class="Identifier">FILTEXT</span></a>, <a href="ic6581/constants.html#EXT"><span class="Identifier">EXT</span></a>, <a href="ic6581/constants.html#PWHI1"><span class="Identifier">PWHI1</span></a>, <a href="ic6581/constants.html#CAP2A"><span class="Identifier">CAP2A</span></a>, <a href="ic6581/constants.html#RING"><span class="Identifier">RING</span></a>, <a href="ic6581/constants.html#PWHI2"><span class="Identifier">PWHI2</span></a>, <a href="ic6581/constants.html#UNUSED1"><span class="Identifier">UNUSED1</span></a>, <a href="ic6581/constants.html#D7"><span class="Identifier">D7</span></a>, <a href="ic6581/constants.html#SUREL2"><span class="Identifier">SUREL2</span></a>, <a href="ic6581/constants.html#VCREG3"><span class="Identifier">VCREG3</span></a>, <a href="ic6581/constants.html#OSC3"><span class="Identifier">OSC3</span></a>, <a href="ic6581/constants.html#D6"><span class="Identifier">D6</span></a>, <a href="ic6581/constants.html#CUTLO"><span class="Identifier">CUTLO</span></a>, <a href="ic6581/constants.html#GND"><span class="Identifier">GND</span></a>, <a href="ic6581/constants.html#FRELO1"><span class="Identifier">FRELO1</span></a>, <a href="ic6581/constants.html#ENV3"><span class="Identifier">ENV3</span></a>, <a href="ic6581/constants.html#FRELO3"><span class="Identifier">FRELO3</span></a>, <a href="ic6581/constants.html#FREHI2"><span class="Identifier">FREHI2</span></a>, <a href="ic6581/constants.html#SUREL1"><span class="Identifier">SUREL1</span></a>, <a href="ic6581/constants.html#CAP1A"><span class="Identifier">CAP1A</span></a>, <a href="ic6581/constants.html#NOISE"><span class="Identifier">NOISE</span></a>, <a href="ic6581/constants.html#SUREL3"><span class="Identifier">SUREL3</span></a>, <a href="ic6581/constants.html#A4"><span class="Identifier">A4</span></a>, <a href="ic6581/constants.html#POTXR"><span class="Identifier">POTXR</span></a>, <a href="ic6581/constants.html#UNUSED2"><span class="Identifier">UNUSED2</span></a>, <a href="ic6581/constants.html#PULSE"><span class="Identifier">PULSE</span></a>
</dl></div>

  </div>
</div>

    <div class="row">
      <div class="twelve-columns footer">
        <span class="nim-sprite"></span>
        <br/>
        <small style="color: var(--hint);">Made with Nim. Generated: 2021-08-09 13:37:42 UTC</small>
      </div>
    </div>
  </div>
</div>

</body>
</html>
