<?xml version="1.0" encoding="utf-8" ?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN"
  "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<!--  This file is generated by Nim. -->
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" />

<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Favicon -->
<link rel="shortcut icon" href="data:image/x-icon;base64,AAABAAEAEBAAAAEAIABoBAAAFgAAACgAAAAQAAAAIAAAAAEAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAUAAAAF////AP///wD///8A////AP///wD///8A////AP///wD///8A////AAAAAAIAAABbAAAAlQAAAKIAAACbAAAAmwAAAKIAAACVAAAAWwAAAAL///8A////AP///wD///8A////AAAAABQAAADAAAAAYwAAAA3///8A////AP///wD///8AAAAADQAAAGMAAADAAAAAFP///wD///8A////AP///wAAAACdAAAAOv///wD///8A////AP///wD///8A////AP///wD///8AAAAAOgAAAJ3///8A////AP///wAAAAAnAAAAcP///wAAAAAoAAAASv///wD///8A////AP///wAAAABKAAAAKP///wAAAABwAAAAJ////wD///8AAAAAgQAAABwAAACIAAAAkAAAAJMAAACtAAAAFQAAABUAAACtAAAAkwAAAJAAAACIAAAAHAAAAIH///8A////AAAAAKQAAACrAAAAaP///wD///8AAAAARQAAANIAAADSAAAARf///wD///8AAAAAaAAAAKsAAACk////AAAAADMAAACcAAAAnQAAABj///8A////AP///wAAAAAYAAAAGP///wD///8A////AAAAABgAAACdAAAAnAAAADMAAAB1AAAAwwAAAP8AAADpAAAAsQAAAE4AAAAb////AP///wAAAAAbAAAATgAAALEAAADpAAAA/wAAAMMAAAB1AAAAtwAAAOkAAAD/AAAA/wAAAP8AAADvAAAA3gAAAN4AAADeAAAA3gAAAO8AAAD/AAAA/wAAAP8AAADpAAAAtwAAAGUAAAA/AAAA3wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAAD/AAAA/wAAAP8AAADfAAAAPwAAAGX///8A////AAAAAEgAAADtAAAAvwAAAL0AAADGAAAA7wAAAO8AAADGAAAAvQAAAL8AAADtAAAASP///wD///8A////AP///wD///8AAAAAO////wD///8A////AAAAAIcAAACH////AP///wD///8AAAAAO////wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A////AP///wD///8A//8AAP//AAD4HwAA7/cAAN/7AAD//wAAoYUAAJ55AACf+QAAh+EAAAAAAADAAwAA4AcAAP5/AAD//wAA//8AAA=="/>
<link rel="icon" type="image/png" sizes="32x32" href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAACAAAAAgCAYAAABzenr0AAAABmJLR0QA/wD/AP+gvaeTAAAACXBIWXMAAA3XAAAN1wFCKJt4AAAAB3RJTUUH4QQQEwksSS9ZWwAAAk1JREFUWMPtll2ITVEUx39nn/O7Y5qR8f05wtCUUr6ZIS++8pEnkZInPImneaCQ5METNdOkeFBKUhMPRIkHKfEuUZSUlGlKPN2TrgfncpvmnntnmlEyq1Z7t89/rf9a6+y99oZxGZf/XeIq61EdtgKXgdXA0xrYAvBjOIF1AI9zvjcC74BSpndrJPkBWDScTF8Aa4E3wDlgHbASaANmVqlcCnwHvgDvgVfAJ+AikAAvgfVZwLnSVZHZaOuKoQi3ZOMi4NkYkpe1p4J7A8BpYAD49hfIy/oqG0+hLomiKP2L5L+1ubn5115S+3OAn4EnwBlgMzCjyt6ZAnQCJ4A7wOs88iRJHvw50HoujuPBoCKwHWiosy8MdfZnAdcHk8dxXFJ3VQbQlCTJvRBCGdRbD4M6uc5glpY3eAihpN5S5w12diSEcCCEcKUO4ljdr15T76ur1FDDLIQQ3qv71EdDOe3Kxj3leRXyk+pxdWnFWod6Wt2bY3de3aSuUHcPBVimHs7mK9WrmeOF6lR1o9qnzskh2ar2qm1qizpfXaPeVGdlmGN5pb09qMxz1Xb1kLqgzn1RyH7JUXW52lr5e/Kqi9qpto7V1atuUzfnARrV7jEib1T76gG2qxdGmXyiekkt1GswPTtek0aBfJp6YySGBfWg2tPQ0FAYgf1stUfdmdcjarbYJEniKIq6gY/Aw+zWHAC+p2labGpqiorFYgGYCEzN7oQdQClN07O1/EfDyGgC0ALMBdYAi4FyK+4H3gLPsxfR1zRNi+NP7nH5J+QntnXe5B5mpfQAAAAASUVORK5CYII=">

<!-- Google fonts -->
<link href='https://fonts.googleapis.com/css?family=Lato:400,600,900' rel='stylesheet' type='text/css'/>
<link href='https://fonts.googleapis.com/css?family=Source+Code+Pro:400,500,600' rel='stylesheet' type='text/css'/>

<!-- CSS -->
<title>nim64/components/chip</title>
<link rel="stylesheet" type="text/css" href="../../nimdoc.out.css">

<script type="text/javascript" src="../../dochack.js"></script>

<script type="text/javascript">
function main() {
  var pragmaDots = document.getElementsByClassName("pragmadots");
  for (var i = 0; i < pragmaDots.length; i++) {
    pragmaDots[i].onclick = function(event) {
      // Hide tease
      event.target.parentNode.style.display = "none";
      // Show actual
      event.target.parentNode.nextElementSibling.style.display = "inline";
    }
  }

  const toggleSwitch = document.querySelector('.theme-switch input[type="checkbox"]');
  function switchTheme(e) {
      if (e.target.checked) {
          document.documentElement.setAttribute('data-theme', 'dark');
          localStorage.setItem('theme', 'dark');
      } else {
          document.documentElement.setAttribute('data-theme', 'light');
          localStorage.setItem('theme', 'light');
      }
  }

  toggleSwitch.addEventListener('change', switchTheme, false);

  const currentTheme = localStorage.getItem('theme') ? localStorage.getItem('theme') : null;
  if (currentTheme) {
    document.documentElement.setAttribute('data-theme', currentTheme);

    if (currentTheme === 'dark') {
      toggleSwitch.checked = true;
    }
  }
}
</script>

</head>
<body onload="main()">
<div class="document" id="documentId">
  <div class="container">
    <h1 class="title">nim64/components/chip</h1>
    <div class="row">
  <div class="three columns">
  <div class="theme-switch-wrapper">
    <label class="theme-switch" for="checkbox">
      <input type="checkbox" id="checkbox" />
      <div class="slider round"></div>
    </label>
    &nbsp;&nbsp;&nbsp; <em>Dark Mode</em>
  </div>
  <div id="global-links">
    <ul class="simple">
    <li>
      <a href="../../theindex.html">Index</a>
    </li>
    </ul>
  </div>
  <div id="searchInputDiv">
    Search: <input type="text" id="searchInput"
      onkeyup="search()" />
  </div>
  <div>
    Group by:
    <select onchange="groupBy(this.value)">
      <option value="section">Section</option>
      <option value="type">Type</option>
    </select>
  </div>
  <ul class="simple simple-toc" id="toc-list">
<ul class="simple"><li><a class="reference" id="pins_toc" href="#pins"><tt class="docutils literal"><span class="pre">pins</span></tt></a></li>
<li><a class="reference" id="registers_toc" href="#registers"><tt class="docutils literal"><span class="pre">registers</span></tt></a></li>
<li><a class="reference" id="init_toc" href="#init"><tt class="docutils literal"><span class="pre">init</span></tt></a></li>
<li><a class="reference" id="debug-properties_toc" href="#debug-properties"><tt class="docutils literal"><span class="pre">debug_properties</span></tt></a></li>
<li><a class="reference" id="debug-procs_toc" href="#debug-procs"><tt class="docutils literal"><span class="pre">debug_procs</span></tt></a></li>
</ul><li>
  <a class="reference reference-toplevel" href="#6" id="56">Imports</a>
  <ul class="simple simple-toc-section">
    
  </ul>
</li>
<li>
  <a class="reference reference-toplevel" href="#17" id="67">Macros</a>
  <ul class="simple simple-toc-section">
      <li><a class="reference" href="#chip.m%2Cuntyped%2Cuntyped"
    title="chip(header, body: untyped): untyped">chip</a></li>

  </ul>
</li>

</ul>

  </div>
  <div class="nine columns" id="content">
  <div id="tocRoot"></div>
  
  <p class="module-desc"></p>
  <div class="section" id="6">
<h1><a class="toc-backref" href="#6">Imports</a></h1>
<dl class="item">
<a class="reference external" href="link.html">link</a>, <a class="reference external" href="pins.html">pins</a>, <a class="reference external" href="registers.html">registers</a>
</dl></div>
<div class="section" id="17">
<h1><a class="toc-backref" href="#17">Macros</a></h1>
<dl class="item">
<a id="chip.m,untyped,untyped"></a>
<dt><pre><span class="Keyword">macro</span> <a href="#chip.m%2Cuntyped%2Cuntyped"><span class="Identifier">chip</span></a><span class="Other">(</span><span class="Identifier">header</span><span class="Other">,</span> <span class="Identifier">body</span><span class="Other">:</span> <span class="Identifier">untyped</span><span class="Other">)</span><span class="Other">:</span> <span class="Identifier">untyped</span></pre></dt>
<dd>

<p>A macro to produce a full definition of a chip from declarative parts.</p>
<p>The macro takes the form of a block definition, with other blocks inside of it. The name of the new chip must be included before the first block begins, right after the <tt class="docutils literal"><span class="pre">chip</span></tt> identifier:</p>
<p><pre class="listing">
chip Ic7406:
</pre></p>
<p>Optionally, a list of parameters can be included in parentheses after the name of the new chip. These must include the name and the type, like normal for parameter lists.</p>
<p><pre class="listing">
chip Ic2364(memory: array[8192, uint8]):
</pre></p>
<p>Inside this <tt class="docutils literal"><span class="pre">chip</span></tt> block there can be one to five other blocks.</p>

<h2><a class="toc-backref" id="pins" href="#pins"><tt class="docutils literal"><span class="pre">pins</span></tt></a></h2><p>The <tt class="docutils literal"><span class="pre">pins</span></tt> block is <em>required</em>. It provides all of the information that the macro needs to produce the chip's pins. These pins are separated into blocks named after the four modes: <tt class="docutils literal"><span class="pre">input</span></tt>, <tt class="docutils literal"><span class="pre">output</span></tt>, <tt class="docutils literal"><span class="pre">bidi</span></tt>, and <tt class="docutils literal"><span class="pre">unconnected</span></tt>. There can only be one instance of a given block; later blocks with the same name will overwrite the first one, which is not something you want.</p>
<p>Within each mode block are the pin definitions, which are exceedingly simple: they are the name of the pin, followed by a colon, followed by the number of that pin.</p>
<p>It is important that the pin numbers are complete and unique. The smallest pin number must be 1, and the largest must be the same as the number of total pins. If any pins are missing in the sequence, or if the same number is used by more than one pin, an error will be thrown and compilation will fail.</p>
<p>Here is an example <tt class="docutils literal"><span class="pre">pins</span></tt> block, one that would be used in a 7406 hex inverter.</p>
<p><pre class="listing"><span class="Identifier">pins</span><span class="Punctuation">:</span>
  <span class="Identifier">input</span><span class="Punctuation">:</span>
    <span class="Identifier">A1</span><span class="Punctuation">:</span> <span class="DecNumber">1</span>
    <span class="Identifier">A2</span><span class="Punctuation">:</span> <span class="DecNumber">3</span>
    <span class="Identifier">A3</span><span class="Punctuation">:</span> <span class="DecNumber">5</span>
    <span class="Identifier">A4</span><span class="Punctuation">:</span> <span class="DecNumber">9</span>
    <span class="Identifier">A5</span><span class="Punctuation">:</span> <span class="DecNumber">11</span>
    <span class="Identifier">A6</span><span class="Punctuation">:</span> <span class="DecNumber">13</span>
  
  <span class="Identifier">output</span><span class="Punctuation">:</span>
    <span class="Identifier">Y1</span><span class="Punctuation">:</span> <span class="DecNumber">2</span>
    <span class="Identifier">Y2</span><span class="Punctuation">:</span> <span class="DecNumber">4</span>
    <span class="Identifier">Y3</span><span class="Punctuation">:</span> <span class="DecNumber">6</span>
    <span class="Identifier">Y4</span><span class="Punctuation">:</span> <span class="DecNumber">8</span>
    <span class="Identifier">Y5</span><span class="Punctuation">:</span> <span class="DecNumber">10</span>
    <span class="Identifier">Y6</span><span class="Punctuation">:</span> <span class="DecNumber">12</span>
  
  <span class="Identifier">unconnected</span><span class="Punctuation">:</span>
    <span class="Identifier">VCC</span><span class="Punctuation">:</span> <span class="DecNumber">14</span>
    <span class="Identifier">GND</span><span class="Punctuation">:</span> <span class="DecNumber">7</span>
</pre></p>

<h2><a class="toc-backref" id="registers" href="#registers"><tt class="docutils literal"><span class="pre">registers</span></tt></a></h2><p>This optional block is used to define registers for those chips that have them. Unlike the <tt class="docutils literal"><span class="pre">pins</span></tt> block, this does not have any sub-blocks; all register definitions go directly under <tt class="docutils literal"><span class="pre">registers</span></tt>. Definitions are the same as in the <tt class="docutils literal"><span class="pre">pins</span></tt> block though: the register name is followed by a colon and then the register index.</p>
<p>Registers begin from index 0, and like the pins, there must be no missing or duplicate indexes. They <em>can</em> share names with pins, though for the ease of defining constants for both pins and registers you should probably refrain from doing so.</p>
<p>If a <tt class="docutils literal"><span class="pre">registers</span></tt> block is provided, then a <tt class="docutils literal"><span class="pre">registers</span></tt> variable will be available in the <tt class="docutils literal"><span class="pre">init</span></tt> section (see below).</p>
<p>Here is a sample <tt class="docutils literal"><span class="pre">registers</span></tt> block, one from a 6526 CIA.</p>
<p><pre class="listing"><span class="Identifier">registers</span><span class="Punctuation">:</span>
  <span class="Identifier">PRA</span><span class="Punctuation">:</span> <span class="DecNumber">0</span>
  <span class="Identifier">PRB</span><span class="Punctuation">:</span> <span class="DecNumber">1</span>
  <span class="Identifier">DDRA</span><span class="Punctuation">:</span> <span class="DecNumber">2</span>
  <span class="Identifier">DDRB</span><span class="Punctuation">:</span> <span class="DecNumber">3</span>
  <span class="Identifier">TALO</span><span class="Punctuation">:</span> <span class="DecNumber">4</span>
  <span class="Identifier">TAHI</span><span class="Punctuation">:</span> <span class="DecNumber">5</span>
  <span class="Identifier">TBLO</span><span class="Punctuation">:</span> <span class="DecNumber">6</span>
  <span class="Identifier">TBHI</span><span class="Punctuation">:</span> <span class="DecNumber">7</span>
  <span class="Identifier">TOD10TH</span><span class="Punctuation">:</span> <span class="DecNumber">8</span>
  <span class="Identifier">TODSEC</span><span class="Punctuation">:</span> <span class="DecNumber">9</span>
  <span class="Identifier">TODMIN</span><span class="Punctuation">:</span> <span class="DecNumber">10</span>
  <span class="Identifier">TODHR</span><span class="Punctuation">:</span> <span class="DecNumber">11</span>
  <span class="Identifier">SDR</span><span class="Punctuation">:</span> <span class="DecNumber">12</span>
  <span class="Identifier">ICR</span><span class="Punctuation">:</span> <span class="DecNumber">13</span>
  <span class="Identifier">CRA</span><span class="Punctuation">:</span> <span class="DecNumber">14</span>
  <span class="Identifier">CRB</span><span class="Punctuation">:</span> <span class="DecNumber">15</span>
</pre></p>

<h2><a class="toc-backref" id="init" href="#init"><tt class="docutils literal"><span class="pre">init</span></tt></a></h2><p>The next possible block is also optional: the <tt class="docutils literal"><span class="pre">init</span></tt> block. This simply contains code that runs when a new instance of the chip is created. This code runs after the pins and registers (if any) are created, and it has access to those pins via the <tt class="docutils literal"><span class="pre">pins</span></tt> variable and those registers via the <tt class="docutils literal"><span class="pre">registers</span></tt> variable. It's used for whatever initialization is necessary; that includes setting handlers on pins, which is where the functionality of a chip comes from in the first place. So the <tt class="docutils literal"><span class="pre">init</span></tt> block can essentially be used to define the entire behavior of a chip.</p>
<p>Both <tt class="docutils literal"><span class="pre">pins</span></tt> and <tt class="docutils literal"><span class="pre">registers</span></tt> can be indexed by either integer (the index) or string (the name). <tt class="docutils literal"><span class="pre">pins</span></tt> is read-only (though of course the returned pin can be modified freely), but <tt class="docutils literal"><span class="pre">registers</span></tt> also is assignable by both integer and string index. Both have iterators for both <tt class="docutils literal"><span class="pre">items</span></tt> and <tt class="docutils literal"><span class="pre">pairs</span></tt>.</p>
<p>If a parameter list was included after the chip name (see above), then variables of those names and types are <em>also</em> made available in the <tt class="docutils literal"><span class="pre">init</span></tt> block. They will be set to the value provided to the generated constructor proc (see below) when a chip is actually created.</p>
<p>If no <tt class="docutils literal"><span class="pre">init</span></tt> block exists, there will still be a constructor proc created, but it'll only create the chip and return it with no custom functionality.</p>
<p>Here is a sample <tt class="docutils literal"><span class="pre">init</span></tt> block, this time from a 2364 ROM. The 2364 definition does not have a <tt class="docutils literal"><span class="pre">registers</span></tt> block so no <tt class="docutils literal"><span class="pre">registers</span></tt> variable is available here, but it does have a parameter named <tt class="docutils literal"><span class="pre">memory</span></tt> with the type <tt class="docutils literal"><span class="pre">array[8192, uint8]</span></tt> that is available in this block (and is in fact referenced in the <tt class="docutils literal"><span class="pre">read</span></tt> proc). The chip definition shown above for the 2364 shows that parameter.</p>
<p>(Any symbol other than <tt class="docutils literal"><span class="pre">pins</span></tt> and <tt class="docutils literal"><span class="pre">memory</span></tt> in this code comes either from a local definition [<tt class="docutils literal"><span class="pre">addr_pins</span></tt>, <tt class="docutils literal"><span class="pre">data_pins</span></tt>, <tt class="docutils literal"><span class="pre">read</span></tt>, <tt class="docutils literal"><span class="pre">enable_listener</span></tt>] or from an import [<tt class="docutils literal"><span class="pre">map</span></tt>, <tt class="docutils literal"><span class="pre">to_seq</span></tt>, <tt class="docutils literal"><span class="pre">Pin</span></tt>, <tt class="docutils literal"><span class="pre">value_to_pins</span></tt>, <tt class="docutils literal"><span class="pre">pins_to_value</span></tt>, <tt class="docutils literal"><span class="pre">lowp</span></tt>, <tt class="docutils literal"><span class="pre">highp</span></tt>, <tt class="docutils literal"><span class="pre">tri_pins</span></tt>, <tt class="docutils literal"><span class="pre">add_listener</span></tt>].)</p>
<p><pre class="listing"><span class="Identifier">init</span><span class="Punctuation">:</span>
  <span class="Keyword">let</span> <span class="Identifier">addr_pins</span> <span class="Operator">=</span> <span class="Identifier">map</span><span class="Punctuation">(</span><span class="Identifier">to_seq</span><span class="Punctuation">(</span><span class="FloatNumber">0.</span><span class="Operator">.</span><span class="DecNumber">12</span><span class="Punctuation">)</span><span class="Punctuation">,</span> <span class="Keyword">proc</span> <span class="Punctuation">(</span><span class="Identifier">i</span><span class="Punctuation">:</span> <span class="Identifier">int</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">Pin</span> <span class="Operator">=</span> <span class="Identifier">pins</span><span class="Punctuation">[</span><span class="Operator">&amp;</span><span class="StringLit">&quot;A{i}&quot;</span><span class="Punctuation">]</span><span class="Punctuation">)</span>
  <span class="Keyword">let</span> <span class="Identifier">data_pins</span> <span class="Operator">=</span> <span class="Identifier">map</span><span class="Punctuation">(</span><span class="Identifier">to_seq</span><span class="Punctuation">(</span><span class="FloatNumber">0.</span><span class="Operator">.</span><span class="DecNumber">7</span><span class="Punctuation">)</span><span class="Punctuation">,</span> <span class="Keyword">proc</span> <span class="Punctuation">(</span><span class="Identifier">i</span><span class="Punctuation">:</span> <span class="Identifier">int</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">Pin</span> <span class="Operator">=</span> <span class="Identifier">pins</span><span class="Punctuation">[</span><span class="Operator">&amp;</span><span class="StringLit">&quot;D{i}&quot;</span><span class="Punctuation">]</span><span class="Punctuation">)</span>
  
  <span class="Keyword">proc</span> <span class="Identifier">read</span> <span class="Operator">=</span>
    <span class="Identifier">value_to_pins</span><span class="Punctuation">(</span><span class="Identifier">memory</span><span class="Punctuation">[</span><span class="Identifier">pins_to_value</span><span class="Punctuation">(</span><span class="Identifier">addr_pins</span><span class="Punctuation">)</span><span class="Punctuation">]</span><span class="Punctuation">,</span> <span class="Identifier">data_pins</span><span class="Punctuation">)</span>
  
  <span class="Keyword">proc</span> <span class="Identifier">enable_listener</span><span class="Punctuation">(</span><span class="Identifier">pin</span><span class="Punctuation">:</span> <span class="Identifier">Pin</span><span class="Punctuation">)</span> <span class="Operator">=</span>
    <span class="Keyword">if</span> <span class="Identifier">lowp</span><span class="Punctuation">(</span><span class="Identifier">pin</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">read</span><span class="Punctuation">(</span><span class="Punctuation">)</span> <span class="Keyword">elif</span> <span class="Identifier">highp</span><span class="Punctuation">(</span><span class="Identifier">pin</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">tri_pins</span><span class="Punctuation">(</span><span class="Identifier">data_pins</span><span class="Punctuation">)</span>
  
  <span class="Identifier">add_listener</span><span class="Punctuation">(</span><span class="Identifier">pins</span><span class="Punctuation">[</span><span class="Identifier">CS</span><span class="Punctuation">]</span><span class="Punctuation">,</span> <span class="Identifier">enable_listener</span><span class="Punctuation">)</span>
</pre></p>

<h2><a class="toc-backref" id="debug-properties" href="#debug-properties"><tt class="docutils literal"><span class="pre">debug_properties</span></tt></a></h2><p>This block is simply a list of names to types, separated by colons in much the same way as the <tt class="docutils literal"><span class="pre">pins</span></tt> or <tt class="docutils literal"><span class="pre">registers</span></tt> blocks. These names and types will be added as properties to the generated chip type, but <em>only if release mode is not enabled</em>. This is intended as a way to expose certin internal chip properties for testing, but to not leave them exposed in production.</p>

<h2><a class="toc-backref" id="debug-procs" href="#debug-procs"><tt class="docutils literal"><span class="pre">debug_procs</span></tt></a></h2><p>Like <tt class="docutils literal"><span class="pre">debug_properties</span></tt>, this section only applies when release mode is not enabled. It can contain any code and is injected after the definitions of the basic procs available to the chip, and it's best used for adding additional procs that are available only for testing.</p>
<p>What follows is a sample <tt class="docutils literal"><span class="pre">debug_properties</span></tt> and <tt class="docutils literal"><span class="pre">debug_procs</span></tt> block, taken from the early stages of 6567 development.</p>
<p><pre class="listing"><span class="Identifier">debug_properties</span><span class="Punctuation">:</span>
  <span class="Identifier">counter</span><span class="Punctuation">:</span> <span class="Identifier">RasterCounter</span>

<span class="Identifier">debug_procs</span><span class="Punctuation">:</span>
  <span class="Keyword">proc</span> <span class="Identifier">counter</span><span class="Operator">*</span><span class="Punctuation">(</span><span class="Identifier">chip</span><span class="Punctuation">:</span> <span class="Identifier">Ic6567</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">RasterCounter</span> <span class="Operator">=</span>
    <span class="Identifier">chip</span><span class="Operator">.</span><span class="Identifier">counter</span>
</pre></p>
<p>This creates a new property, <tt class="docutils literal"><span class="pre">counter</span></tt>, on the <tt class="docutils literal"><span class="pre">Ic6567</span></tt> generated type, and it provides a proc to return its value. Note that there's nothing in this code that will actually initially set the value of that new <tt class="docutils literal"><span class="pre">counter</span></tt> property, so these lines also appear in the <tt class="docutils literal"><span class="pre">init</span></tt> block:</p>
<p><pre class="listing"><span class="Keyword">let</span> <span class="Identifier">counter</span> <span class="Operator">=</span> <span class="Identifier">new_raster_counter</span><span class="Punctuation">(</span><span class="Punctuation">)</span>
<span class="Keyword">when</span> <span class="Keyword">not</span> <span class="Identifier">defined</span><span class="Punctuation">(</span><span class="Identifier">release</span><span class="Punctuation">)</span><span class="Punctuation">:</span> <span class="Identifier">result</span><span class="Operator">.</span><span class="Identifier">counter</span> <span class="Operator">=</span> <span class="Identifier">counter</span>
</pre></p>
<p>(In the <tt class="docutils literal"><span class="pre">init</span></tt> block, the chip itself is available as <tt class="docutils literal"><span class="pre">result</span></tt>.)</p>
<p>The <tt class="docutils literal"><span class="pre">debug_properties</span></tt> and <tt class="docutils literal"><span class="pre">debug_procs</span></tt> block, along with the <tt class="docutils literal"><span class="pre">when not defined(release)</span></tt> statement, will only be included in the generated code when it's not compiled in release mode. In debug mode, however, they are all available. This provides a way to access the chip's raster counter, which wouldn't normally be available, for testing.</p>
<p>With all of that for input, this macro provides quite a lot.</p>
<ul class="simple"><li>A type with the same name as appeared after <tt class="docutils literal"><span class="pre">chip</span></tt> is created and exported. It has no exported properties, but it does have exported overloads of the <tt class="docutils literal"><span class="pre">[]</span></tt> operator. These let a chip instance be indexed by pin number or pin name, and the pin of that number or name is the result. It also has iterators exported both for <tt class="docutils literal"><span class="pre">items</span></tt> and for <tt class="docutils literal"><span class="pre">pairs</span></tt>, both of which also yield pins; the proc <tt class="docutils literal"><span class="pre">len</span></tt>, which returns the number of pins in the chip; and the proc <tt class="docutils literal"><span class="pre">pins</span></tt>, which returns a sequence of tuples that give information about all of the pins without being mutable <tt class="docutils literal"><span class="pre">Pin</span></tt> objects themselves.</li>
<li>A constructor proc with a name equal to &quot;new&quot; plus the type name is exported. This proc creates all of the chip's pins and prepares the indexing, along with whatever the user provides in the <tt class="docutils literal"><span class="pre">init</span></tt> block. If a parameter list was provided with the chip name, this proc will take the same parameters, and they will be available to the rest of the code in the <tt class="docutils literal"><span class="pre">init</span></tt> block.</li>
<li>A <tt class="docutils literal"><span class="pre">pins</span></tt> variable is made available in the <tt class="docutils literal"><span class="pre">init</span></tt> block. This variable has <tt class="docutils literal"><span class="pre">[]</span></tt> (for both name and number) and <tt class="docutils literal"><span class="pre">len</span></tt> procs attached to it, along with <tt class="docutils literal"><span class="pre">items</span></tt> and <tt class="docutils literal"><span class="pre">pairs</span></tt> iterators.</li>
<li>Any parameters included after the chip name will also be made available in the <tt class="docutils literal"><span class="pre">init</span></tt> block.</li>
</ul>
<p>If a <tt class="docutils literal"><span class="pre">registers</span></tt> block is present in the chip definition, the macro does a few additional things.</p>
<ul class="simple"><li>The chip type has an additional proc called <tt class="docutils literal"><span class="pre">registers</span></tt>, which returns a sequence of two-element tuples containing names and values of each register (the index of the register is equal to its index in the sequence).</li>
<li>A <tt class="docutils literal"><span class="pre">registers</span></tt> variable becomes available in the <tt class="docutils literal"><span class="pre">init</span></tt> block. This has the same <tt class="docutils literal"><span class="pre">[]</span></tt> (again, for both name and number) and <tt class="docutils literal"><span class="pre">len</span></tt> procs and <tt class="docutils literal"><span class="pre">items</span></tt> and <tt class="docutils literal"><span class="pre">pairs</span></tt> iterators that the <tt class="docutils literal"><span class="pre">pins</span></tt> variable does. However, it also defines <tt class="docutils literal"><span class="pre">[]=</span></tt> for both name and number to be able to set the values of registers from within the <tt class="docutils literal"><span class="pre">init</span></tt> block.</li>
</ul>
<p>Constants used to be provided by the macro as well, but as some more complex chips will want to define constants in a separate file, the constant generation was removed.</p>


</dd>

</dl></div>

  </div>
</div>

    <div class="row">
      <div class="twelve-columns footer">
        <span class="nim-sprite"></span>
        <br/>
        <small style="color: var(--hint);">Made with Nim. Generated: 2021-08-09 13:37:41 UTC</small>
      </div>
    </div>
  </div>
</div>

</body>
</html>
